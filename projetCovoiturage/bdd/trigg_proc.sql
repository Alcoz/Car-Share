/*
  21503877 Darnala Baptiste
  20140442 Eliott Duverger
*/

DROP PROCEDURE IF EXISTS moyenne;
DELIMITER |
CREATE PROCEDURE moyenne (IN uti_id INT)
BEGIN
    SELECT AVG(NOTES) INTO notes
    FROM UTILISATEUR, AVIS
    WHERE AVIS.ID_CONDUCTEUR = UTILISATEUR.ID_UTILISATEUR
    AND uti_id = AVIS.ID_CONDUCTEUR;
END |
DELIMITER ;

DROP PROCEDURE IF EXISTS nb_traj_dispo;
DELIMITER |
CREATE PROCEDURE nb_traj_dispo (OUT nb_traj INT)
BEGIN
    SELECT COUNT(*) INTO nb_traj
    FROM TRAJET
    WHERE DISPONIBLE = TRUE
    AND DATE_DEP > NOW();
END |
DELIMITER ;


DROP TRIGGER IF EXISTS prix_abuse;
DELIMITER |
CREATE TRIGGER prix_abuse BEFORE INSERT
ON TRAJET FOR EACH ROW
BEGIN
    IF NEW.PRIX > (NEW.DISTANCE * 0.1)
      THEN
        SET NEW.PRIX = NEW.DISTANCE*0.1;
    END IF;
END |
DELIMITER ;

DROP TRIGGER IF EXISTS traj_complet;
DELIMITER |
CREATE TRIGGER traj_complet BEFORE UPDATE
ON TRAJET FOR EACH ROW
BEGIN

    IF NEW.NB_PLACE = 0
      THEN
        SET NEW.DISPONIBLE = FALSE;
    END IF;
END |
DELIMITER;
